<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>hserus5</title>
  <style>
    body { font-family: Arial, sans-serif; background: #f8f9fa; margin: 20px; }
    h2 { margin-bottom: 10px; }
    #progress { margin: 10px 0; font-weight: bold; }
    table { width: 100%; border-collapse: collapse; background: white; }
    th, td { border: 1px solid #ddd; padding: 8px; text-align: center; }
    th { background: #007bff; color: white; cursor: pointer; }
    tr:nth-child(even) { background: #f2f2f2; }
    button { margin: 10px 0; padding: 8px 16px; cursor: pointer; background: #007bff; color: white; border: none; border-radius: 5px; }
    button:hover { background: #0056b3; }
  </style>
</head>
<body>
  <h2>hserus5</h2>
  <button onclick="loadScanner()">ðŸ”„ Refresh</button>
  <div id="progress">Progress: 0 / 250</div>
  <table id="scannerTable">
    <thead>
      <tr>
        <th onclick="sortTable(0)">Symbol</th>
        <th onclick="sortTable(1)">Close % (1h)</th>
        <th onclick="sortTable(2)">Vol % (1h)</th>
        <th onclick="sortTable(3)">Cycle %</th>
        <th onclick="sortTable(4)">Curr FR</th>
        <th onclick="sortTable(5)">Prev FR</th>
        <th onclick="sortTable(6)">FR Î”%</th>
        <th onclick="sortTable(7)">Cycle</th>
      </tr>
    </thead>
    <tbody></tbody>
  </table>

  <script>
    const BASE_URL = "https://fapi.binance.com/fapi/v1";
    const excludeSymbols = ["BTCUSDT","ETHUSDT","BNBUSDT","SOLUSDT","XRPUSDT","ADAUSDT","AVAXUSDT","DOGEUSDT","TRXUSDT","DOTUSDT",
                            "LINKUSDT","MATICUSDT","SHIBUSDT","BCHUSDT","LTCUSDT","ICPUSDT","NEARUSDT","UNIUSDT","ETCUSDT","APTUSDT",
                            "FILUSDT","OPUSDT","XLMUSDT","INJUSDT","SUIUSDT","IMXUSDT","ATOMUSDT","ARBUSDT","GRTUSDT","MKRUSDT"]; // top 30 mcap to exclude

    async function fetchJSON(url) {
      const res = await fetch(url);
      return res.json();
    }

    async function loadScanner() {
      document.querySelector("#progress").innerText = "Progress: 0 / 250";
      const tbody = document.querySelector("#scannerTable tbody");
      tbody.innerHTML = "";

      const exchangeInfo = await fetchJSON(`${BASE_URL}/exchangeInfo`);
      let symbols = exchangeInfo.symbols.filter(s => s.contractType === "PERPETUAL" && s.symbol.endsWith("USDT"))
                        .map(s => s.symbol);

      // Filter out excluded symbols
      symbols = symbols.filter(sym => !excludeSymbols.includes(sym));
      symbols = symbols.slice(0, 250);

      let count = 0;
      for (let sym of symbols) {
        count++;
        document.querySelector("#progress").innerText = `Scanning: ${count} / ${symbols.length}`;

        try {
          // kline for 1h
          const klines = await fetchJSON(`${BASE_URL}/klines?symbol=${sym}&interval=1h&limit=2`);
          const prev = klines[0], curr = klines[1];
          const prevClose = parseFloat(prev[4]), currClose = parseFloat(curr[4]);
          const prevVol = parseFloat(prev[5]), currVol = parseFloat(curr[5]);

          const closeChg = ((currClose - prevClose) / prevClose * 100).toFixed(2);
          const volChg = ((currVol - prevVol) / prevVol * 100).toFixed(2);

          // Funding rates
          const funding = await fetchJSON(`${BASE_URL}/fundingRate?symbol=${sym}&limit=2`);
          if (funding.length < 2) continue;
          const prevFR = parseFloat(funding[1].fundingRate) * 100;
          const currFR = parseFloat(funding[0].fundingRate) * 100;

          // Exclude 0.01% and 0.005%
          if ([0.01, 0.005].includes(Math.abs(prevFR)) || [0.01, 0.005].includes(Math.abs(currFR))) continue;

          if (prevFR === currFR) continue; // skip if same

          const frDelta = (currFR - prevFR).toFixed(4);
          const frDeltaPerc = prevFR !== 0 ? ((currFR - prevFR) / Math.abs(prevFR) * 100).toFixed(2) : "NA";
          const cycle = "8h"; // Binance perpetual default

          // Cycle % (since start of FR cycle)
          const now = new Date();
          const cycleStartHour = Math.floor(now.getUTCHours() / 8) * 8;
          const cycleStart = new Date(Date.UTC(now.getUTCFullYear(), now.getUTCMonth(), now.getUTCDate(), cycleStartHour, 0, 0));
          const klinesCycle = await fetchJSON(`${BASE_URL}/klines?symbol=${sym}&interval=1h&startTime=${cycleStart.getTime()}`);
          if (!klinesCycle.length) continue;
          const startClose = parseFloat(klinesCycle[0][4]);
          const cycleCloseChg = ((currClose - startClose) / startClose * 100).toFixed(2);

          // Add row
          const row = `<tr>
            <td>${sym}</td>
            <td>${closeChg}</td>
            <td>${volChg}</td>
            <td>${cycleCloseChg}</td>
            <td>${currFR.toFixed(4)}%</td>
            <td>${prevFR.toFixed(4)}%</td>
            <td>${frDeltaPerc}%</td>
            <td>${cycle}</td>
          </tr>`;
          tbody.insertAdjacentHTML("beforeend", row);

        } catch (err) {
          console.error("Error for symbol", sym, err);
        }
      }
      document.querySelector("#progress").innerText = `Completed: ${symbols.length} symbols scanned`;
    }

    function sortTable(n) {
      const table = document.getElementById("scannerTable");
      let switching = true, dir = "asc", switchcount = 0;
      while (switching) {
        switching = false;
        const rows = table.rows;
        for (let i = 1; i < rows.length - 1; i++) {
          let shouldSwitch = false;
          let x = rows[i].getElementsByTagName("TD")[n];
          let y = rows[i + 1].getElementsByTagName("TD")[n];
          let cmpx = parseFloat(x.innerHTML) || x.innerHTML.toLowerCase();
          let cmpy = parseFloat(y.innerHTML) || y.innerHTML.toLowerCase();
          if (dir === "asc" && cmpx > cmpy) { shouldSwitch = true; break; }
          if (dir === "desc" && cmpx < cmpy) { shouldSwitch = true; break; }
        }
        if (shouldSwitch) {
          rows[i].parentNode.insertBefore(rows[i + 1], rows[i]);
          switching = true; switchcount++;
        } else {
          if (switchcount === 0 && dir === "asc") { dir = "desc"; switching = true; }
        }
      }
    }

    loadScanner();
  </script>
</body>
</html>
