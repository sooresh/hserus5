<!DOCTYPE html>
<html>
<head>
<meta charset="UTF-8">
<title>hserus5</title>
<style>
body { font-family: Arial; background:#111; color:#fff; padding:20px; }
button { padding:10px 18px; margin-bottom:15px; cursor:pointer; font-size:16px; }
table { width:100%; border-collapse:collapse; margin-top:15px; }
th, td { padding:8px; text-align:center; border-bottom:1px solid #333; }
th { cursor:pointer; background:#222; position:sticky; top:0; }
#progressBox { width:100%; height:22px; background:#333; border-radius:10px; margin-top:10px; }
#bar { height:22px; width:0%; background:#4caf50; border-radius:10px; transition:0.25s; }
</style>
</head>
<body>

<button onclick="startScan()">Refresh</button>
<div id="progressText">Progress: 0%</div>
<div id="progressBox"><div id="bar"></div></div>

<table id="dataTable">
<thead>
<tr>
<th data-col="symbol">Symbol</th>
<th data-col="closePct">Close %</th>
<th data-col="volPct">Vol %</th>
<th data-col="bbPct">BB %</th>
<th data-col="same">Same?</th>
</tr>
</thead>
<tbody></tbody>
</table>

<script>
async function fetchJSON(url){
    return fetch(url).then(r=>r.json());
}

async function getTopVolatileSymbols(){
    const all = await fetchJSON("https://fapi.binance.com/fapi/v1/ticker/24hr");
    let filtered = all
        .filter(s => s.symbol.endsWith("USDT"))
        .sort((a,b)=>Number(b.volume)-Number(a.volume))
        .slice(0,300);

    // Exclude top 20 global market cap coins
    const exclude = ["BTC","ETH","SOL","BNB","XRP","DOGE","ADA","AVAX","DOT","LINK","TRX",
                     "MATIC","SHIB","UNI","TON","LTC","ATOM","BCH","ETC","OP","APT","FIL"];

    filtered = filtered.filter(x => !exclude.includes(x.symbol.replace("USDT","")));
    return filtered.slice(0,250).map(s=>s.symbol);
}

function calcSMA(values){
    return values.reduce((a,b)=>a+b,0) / values.length;
}

function candleColor(o,c){
    return c>o ? "green" : (c<o?"red":"doji");
}

function pct(a,b){ return ((a-b)/b)*100; }

async function scanSymbol(symbol){
    try{
        const url = `https://fapi.binance.com/fapi/v1/klines?symbol=${symbol}&interval=1h&limit=30`;
        const k = await fetchJSON(url);
        if(!k || k.length<21) return null;

        const closes = k.map(x=>Number(x[4]));
        const mids = calcSMA(closes.slice(-20));
        const prevMids = calcSMA(closes.slice(-21, -1));
        
        const cur = k[k.length-1];
        const prev = k[k.length-2];

        const o = Number(cur[1]);
        const c = Number(cur[4]);
        const v = Number(cur[5]);

        const po = Number(prev[1]);
        const pc = Number(prev[4]);
        const pv = Number(prev[5]);

        const curColor = candleColor(o,c);

        // Conditions
        if(v <= pv * 1.6) return null;
        if(curColor === "green" && !(o < mids)) return null;
        if(curColor === "red"   && !(o > mids)) return null;

        return {
            symbol,
            closePct: pct(c,o).toFixed(2),
            volPct: pct(v,pv).toFixed(2),
            bbPct: pct(mids, prevMids).toFixed(2),
            same: candleColor(po,pc) === curColor ? "yes" : "no"
        };
    }catch(e){
        return null;
    }
}

let sortState = {col:null,asc:true};

function sortTable(col){
    const table = document.getElementById("dataTable").querySelector("tbody");
    let rows = [...table.querySelectorAll("tr")];
    const asc = sortState.col===col ? !sortState.asc : true;

    rows.sort((a,b)=>{
        const x = a.querySelector(`td[data-col='${col}']`).innerText;
        const y = b.querySelector(`td[data-col='${col}']`).innerText;
        const xn = Number(x), yn = Number(y);
        if(!isNaN(xn) && !isNaN(yn)) return asc ? xn-yn : yn-xn;
        return asc ? x.localeCompare(y) : y.localeCompare(x);
    });

    sortState = {col,asc};
    rows.forEach(r=>table.appendChild(r));
}

document.querySelectorAll("th").forEach(th=>{
    th.addEventListener("click",()=>sortTable(th.dataset.col));
});

async function startScan(){
    document.getElementById("bar").style.width="0%";
    document.getElementById("progressText").innerText="Progress: 0%";
    const tbody = document.querySelector("#dataTable tbody");
    tbody.innerHTML="";

    const symbols = await getTopVolatileSymbols();
    const batchSize = 20;
    let results = [];
    let done = 0;

    for(let i=0;i<symbols.length;i+=batchSize){
        const batch = symbols.slice(i,i+batchSize);
        const data = await Promise.all(batch.map(scanSymbol));
        results.push(...data.filter(Boolean));

        done += batch.length;
        let pctDone = Math.min(100, ((done/symbols.length)*100).toFixed(0));
        document.getElementById("bar").style.width = pctDone+"%";
        document.getElementById("progressText").innerText=`Progress: ${pctDone}%`;
    }

    for(const r of results){
        const tr = document.createElement("tr");
        tr.innerHTML = `
            <td data-col="symbol">${r.symbol}</td>
            <td data-col="closePct">${r.closePct}</td>
            <td data-col="volPct">${r.volPct}</td>
            <td data-col="bbPct">${r.bbPct}</td>
            <td data-col="same">${r.same}</td>
        `;
        tbody.appendChild(tr);
    }
}
</script>
</body>
</html>
