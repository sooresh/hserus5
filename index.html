<!DOCTYPE html>
<html>
<head>
<title>hserus5</title>
<style>
    body { font-family: Arial; padding: 20px; background: #f4f4f4; }
    #scanBtn { padding: 10px 18px; background: #007bff; border: none; color: #fff;
               cursor: pointer; border-radius: 5px; }
    #scanBtn:hover { background: #0056b3; }

    #progressBarWrap { width: 100%; background: #ccc; height: 20px; border-radius: 10px; margin-top: 15px; }
    #progressBar { height: 100%; width: 0%; background: #28a745; border-radius: 10px; transition: width 0.25s; }
    #progressText { margin-top: 5px; font-size: 14px; }

    table { width: 100%; margin-top: 20px; border-collapse: collapse; background: white; }
    th, td { padding: 8px; border: 1px solid #ddd; text-align: center; }
    th { background: #eee; cursor: pointer; }
</style>
</head>
<body>

<h2>hserus5</h2>

<button id="scanBtn">Refresh</button>

<div id="progressBarWrap"><div id="progressBar"></div></div>
<div id="progressText">0%</div>

<table id="resultTable">
    <thead>
        <tr>
            <th data-col="symbol">Symbol</th>
            <th data-col="closePct">Close %</th>
            <th data-col="volPct">Vol %</th>
            <th data-col="midPct">Mid %</th>
            <th data-col="same">Same</th>
            <th data-col="midFlip">MidFlip</th>
        </tr>
    </thead>
    <tbody></tbody>
</table>

<script>
// -------------------------- CONFIG --------------------------
const EXCLUDE = ["BTCUSDT","ETHUSDT","BNBUSDT","SOLUSDT","XRPUSDT","ADAUSDT","DOGEUSDT","AVAXUSDT","DOTUSDT","LINKUSDT","TRXUSDT","MATICUSDT","SHIBUSDT","LTCUSDT","ATOMUSDT","UNIUSDT","XLMUSDT","ETCUSDT","FILUSDT","HBARUSDT","ICPUSDT","APTUSDT","ARBUSDT","OPUSDT","SANDUSDT","AAVEUSDT"];  
const BATCH = 20;

// -------------------------- FETCH FUNCTION --------------------------
async function getJSON(url){
    const r = await fetch(url);
    if(!r.ok) throw new Error("Fetch failed");
    return r.json();
}

// -------------------------- MAIN SCAN FUNCTION --------------------------
async function scan(){

    document.querySelector("#progressBar").style.width = "0%";
    document.querySelector("#progressText").innerText = "Starting...";

    const futures = await getJSON("https://fapi.binance.com/fapi/v1/exchangeInfo");
    let symbols = futures.symbols
        .filter(s => s.contractType === "PERPETUAL" && s.quoteAsset === "USDT")
        .map(s => s.symbol)
        .filter(s => !EXCLUDE.includes(s));

    symbols = symbols.slice(0,250);

    const out = [];
    let done = 0;
    const total = symbols.length;

    for(let i=0; i<symbols.length; i+=BATCH){
        let batch = symbols.slice(i, i+BATCH);
        let promises = batch.map(sym => processSymbol(sym).catch(()=>null));
        let results = await Promise.all(promises);

        results.forEach(r => { if(r) out.push(r); });

        done += batch.length;
        let pct = Math.floor((done/total)*100);
        document.querySelector("#progressBar").style.width = pct + "%";
        document.querySelector("#progressText").innerText = pct + "%";
    }

    out.sort((a,b)=>Math.abs(b.closePct)-Math.abs(a.closePct));

    fillTable(out);
}

// -------------------------- PROCESS ONE SYMBOL --------------------------
async function processSymbol(symbol){

    const k = await getJSON(`https://fapi.binance.com/fapi/v1/klines?symbol=${symbol}&interval=1h&limit=22`);

    let row1 = k[k.length-1];
    let row2 = k[k.length-2];
    let row3 = k[k.length-3];

    let o = parseFloat(row1[1]), h = parseFloat(row1[2]),
        l = parseFloat(row1[3]), c = parseFloat(row1[4]),
        v = parseFloat(row1[5]);

    let prevC = parseFloat(row2[4]), prevV = parseFloat(row2[5]);
    let prevPrevC = parseFloat(row3[4]);

    let closePct = ((c - prevC) / prevC) * 100;
    let volPct = ((v - prevV) / prevV) * 100;

    // ------------------ Bollinger Bands ------------------
    let closes = k.map(r => parseFloat(r[4]));
    let arr20 = closes.slice(-20);

    const mean = arr20.reduce((a,b)=>a+b,0)/20;
    const std = Math.sqrt(arr20.map(x=>Math.pow(x-mean,2)).reduce((a,b)=>a+b,0)/20);

    const midBand = mean;
    const prevMidBand = mean - ((closes[closes.length-1] - closes[closes.length-2]) / closes[closes.length-2]) * (mean);

    let midPct = ((midBand - prevMidBand) / prevMidBand) * 100;

    // ------------------ Same Colour ------------------
    let same = ((c>o) === (prevC>parseFloat(row2[1]))) ? "Yes" : "No";

    // ------------------ NEW COLUMN: MidFlip ------------------
    let midFlip = "No";

    if(c > o){
        if(h > midBand && c < midBand) midFlip = "Yes";
    } else {
        if(l < midBand && c > midBand) midFlip = "Yes";
    }

    return {
        symbol,
        closePct: closePct.toFixed(2),
        volPct: volPct.toFixed(2),
        midPct: midPct.toFixed(2),
        same,
        midFlip
    };
}

// -------------------------- FILL TABLE --------------------------
function fillTable(data){
    const tb = document.querySelector("#resultTable tbody");
    tb.innerHTML = "";

    data.forEach(d=>{
        let tr = document.createElement("tr");
        tr.innerHTML = `
            <td>${d.symbol}</td>
            <td>${d.closePct}</td>
            <td>${d.volPct}</td>
            <td>${d.midPct}</td>
            <td>${d.same}</td>
            <td>${d.midFlip}</td>
        `;
        tb.appendChild(tr);
    });
}

// -------------------------- SORTING --------------------------
document.querySelectorAll("th").forEach(th=>{
    th.onclick = function(){
        let col = th.getAttribute("data-col");
        sortTable(col);
    };
});

function sortTable(col){
    let tb = document.querySelector("#resultTable tbody");
    let rows = Array.from(tb.querySelectorAll("tr"));

    let asc = !(tb.getAttribute("data-sort-"+col) === "asc");
    tb.setAttribute("data-sort-"+col, asc ? "asc" : "desc");

    rows.sort((a,b)=>{
        let va = a.children[getColIndex(col)].innerText;
        let vb = b.children[getColIndex(col)].innerText;

        va = isNaN(va) ? va : parseFloat(va);
        vb = isNaN(vb) ? vb : parseFloat(vb);

        if(va < vb) return asc ? -1 : 1;
        if(va > vb) return asc ? 1 : -1;
        return 0;
    });

    rows.forEach(r=>tb.appendChild(r));
}

function getColIndex(col){
    let headers = document.querySelectorAll("th");
    for(let i=0;i<headers.length;i++){
        if(headers[i].getAttribute("data-col") === col) return i;
    }
    return 0;
}

// -------------------------- BUTTON --------------------------
document.querySelector("#scanBtn").onclick = scan;
</script>

</body>
</html>
